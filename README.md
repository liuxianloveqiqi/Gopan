# Gopan-基于go-zero的分布式网盘项目

## User服务

### 手机短信一键注册登录

外接腾讯云SMS服务，填写验证码后自动进行注册或者登录判断，免得先注册才能再登录，提高用户体验

### 格式和边界值的校验

使用valiata包进行校验，并且加上中文翻译器，这样也不必进行繁琐的格式或者边界校验，自动返回翻译后的错误

### github第三方登录

使用GitHub OAuth进行第三方登录

## Upload服务

### 普通上传

- 可以选择本地或者minio存储或者腾讯云COS进行存储

![image-20230708153557534](https://raw.githubusercontent.com/liuxianloveqiqi/Xian-imagehost/main/image/image-20230708153557534.png)

### kafka异步处理Mysql存储文件元信息

异步处理，可以让用户不用等待文件元信息存入mysql的所需的时间，提高用户体验。针对高并发场景，提高吞吐量。

- 使用批量消息聚合提升kafka性能

![image-20230708153904061](https://raw.githubusercontent.com/liuxianloveqiqi/Xian-imagehost/main/image/image-20230708153904061.png)

之前每向kafka发送一条消息就会产生一次网络 IO 和一次磁盘 IO，做消息聚合后，比如聚合 100 条消息后再发送给 Kafka，这个时候 100 条消息才会产生一次网络 IO 和磁盘 IO，这样大大提高 Kafka 的吞吐和性能。并且有聚合时间兜底，就算消息数量达不到聚合要求，超过聚合最大时间也会聚合当前所有消息发送给Kafka

### 秒传

根据文件的sha1值判断，先从file表里面查出是否有该sha1值，如果有就只需要将file表里的file添加到对应userfile表里面就可以了，这样就实现了秒传的功能

### 分块上传&&断点续传

客户端将文件分成几份，每次一都上传一份，然后服务端接受客户端上传的分块文件存入本地，在redis中记录分块文件信息，等客户端上传完后调用服务端的接口，服务端校验文件分块已经上传成功后进行合并文件再上传到对应的存储，之后也使用kafka来异步处理文件元信息。断点续传就是查询之前上传过的分块，从未上传的分块开始继续传

## download服务

### 腾讯云COS下载

利用官方SDK进行分块下载到本地，然后返回文件给客户端

### Minio下载

实现了并发从minio下载分块文件，下载所有分块后进行合并分块返回合并后的文件给客户端

## transfer服务

通过将消息随机发到多个 goroutine中来并发消费数据，再将消费的文件元信息写入mysql。
